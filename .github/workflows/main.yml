name: CI-DockerBuild

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      NAMESPACE: lpintofsgrp-dev
      CHART_PATH: ./chart
      RELEASE_NAME: infra-seguridad

    steps:
      # üß© 1Ô∏è‚É£ Clonar el repositorio
      - name: Checkout repository
        uses: actions/checkout@v4

      # üß∞ 2Ô∏è‚É£ Instalar OC CLI (cliente de OpenShift)
      - name: Install OC CLI
        run: |
          curl -L https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz | tar xz
          sudo mv oc /usr/local/bin/
          oc version --client

      # üîë 3Ô∏è‚É£ Autenticaci√≥n en OpenShift
      - name: Log in to OpenShift
        uses: redhat-actions/oc-login@v1
        with:
          openshift_server_url: ${{ secrets.OPENSHIFT_SERVER }}
          openshift_token: ${{ secrets.OPENSHIFT_TOKEN }}
          insecure_skip_tls_verify: true  # ‚ö†Ô∏è quitar si usas certificados v√°lidos

      # üèóÔ∏è 4Ô∏è‚É£ Asegurar que el namespace exista
      - name: Ensure project exists
        run: |
          oc get project $NAMESPACE || oc new-project $NAMESPACE
          echo "‚úÖ Namespace listo: $NAMESPACE"

      # ‚öôÔ∏è 5Ô∏è‚É£ Instalar Helm (por si la runner no lo tiene)
      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          helm version

      # üöÄ 6Ô∏è‚É£ Aplicar las NetworkPolicies v√≠a Helm
      - name: Deploy NetworkPolicies via Helm
        run: |
          helm upgrade --install $RELEASE_NAME $CHART_PATH \
            -n $NAMESPACE \
            --wait --timeout 5m \
            --atomic \
            --set appNamespace=$NAMESPACE
          echo "‚úÖ NetworkPolicies desplegadas con √©xito"

      # üîé 7Ô∏è‚É£ Validar despliegue
      - name: Verify NetworkPolicies
        run: |
          echo "üîç Pol√≠ticas aplicadas:"
          oc get networkpolicy -n $NAMESPACE
          echo
          echo "üîç Revisi√≥n del release Helm:"
          helm status $RELEASE_NAME -n $NAMESPACE
